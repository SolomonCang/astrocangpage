document.addEventListener("DOMContentLoaded",(()=>{function e(e){if(!e)return;p.innerHTML=`Loading: <em>${e.name}</em>`,h.textContent="Processing...";const l=new FileReader;l.onload=n=>{t(n.target.result,e.name)},l.onerror=()=>{n("An error occurred while reading the file.")},l.readAsText(e)}function t(e,t=null){let o;if("string"!=typeof e)return L?void u():void 0;o=e;try{const e=document.querySelector('input[name="file-type"]:checked').value;L=a(o,e),l(t),u()}catch(e){n(e.message)}}function n(e){L=null,I.innerHTML=`<p style="color: red; text-align: center; padding: 20px;">Error: ${e}</p>`,h.textContent="Load failed",x.innerHTML="<small>Loading failed.</small>",p&&(p.innerHTML="Load failed, please try again. <a>Click to choose file</a>")}function l(e){if(!L)return;e&&(p.innerHTML=`Loaded: <em>${e}</em>. Drag or choose a new file to replace.`);const t={spec_pol:"Spec (pol)",spec_i:"Spec (I)",lsd_pol:"LSD (pol)",lsd_i:"LSD (I)"};h.textContent=t[L.resolvedType]||L.resolvedType,x.innerHTML="";const n=L.columns.filter((e=>e!==L.xCol&&"order_id"!==e)),l=["Int","Pol","Null1"];n.forEach((e=>{const t=document.createElement("div");t.style.display="inline-block",t.style.marginRight="15px";const n=document.createElement("input");n.type="checkbox",n.id=`col-${e}`,n.value=e,n.checked=l.includes(e);const a=document.createElement("label");a.htmlFor=`col-${e}`,a.textContent=e,t.appendChild(n),t.appendChild(a),x.appendChild(t)}));const a=L.resolvedType.startsWith("spec");v.style.display=a?"block":"none"}function a(e,t){const n=e.split("\n").filter((e=>!e.trim().startsWith("*")));let l=-1;for(let e=0;e<n.length;e++){if(n[e].trim().split(/\s+/).reduce(((e,t)=>e+(isFinite(t)&&""!==t?1:0)),0)>=3){l=e;break}}if(-1===l&&(l=n.findIndex((e=>e.trim().split(/\s+/).length>=2)),-1===l))throw new Error("Could not find valid data lines in the file.");const a=n.slice(l).map((e=>e.trim().split(/\s+/).map(parseFloat))).filter((e=>e.length>0&&!e.some(isNaN)));if(0===a.length)throw new Error("No valid data after parsing.");const r=a[0].length;let s,d,c;const u=e=>{const t=o(r,e);if(!t)throw new Error(`The file has ${r} columns, which does not match the requirements for the selected type ${e}.`);return{...t,resolvedType:e}};if("auto"===t){if(s=i(a),!s)throw new Error("Unable to automatically determine data type. Please select manually.");({columnNames:d,xCol:c}=u(s))}else({columnNames:d,xCol:c,resolvedType:s}=u(t));const m={};d.forEach((e=>m[e]=[])),a.forEach((e=>{for(let t=0;t<d.length;t++)void 0!==e[t]&&m[d[t]].push(e[t])}));const p=m[c];let f=-1/0,h=0;return m.order_id=p.map((e=>(e<f&&h++,f=e,h))),{data:m,columns:[...d,"order_id"],xCol:c,resolvedType:s}}function o(e,t){const n={spec_pol:{ncol:6,names:["Wav","Int","Pol","Null1","Null2","sigma_int"],xCol:"Wav"},spec_i:{ncol:3,names:["Wav","Int","sigma_int"],xCol:"Wav"},lsd_pol:{ncol:7,names:["RV","Int","sigma_int","Pol","sigma_pol","Null1","sigma_null1"],xCol:"RV"},lsd_i:{ncol:3,names:["RV","Int","sigma_int"],xCol:"RV"}}[t];return n&&n.ncol===e?{columnNames:n.names,xCol:n.xCol}:null}function i(e){if(!e||0===e.length)return null;const t=e[0].length;if(6===t)return"spec_pol";if(7===t)return"lsd_pol";if(3===t){const t=e.map((e=>e[0])),n=Math.min(...t),l=Math.max(...t),a=n>=200&&l<=5e3,o=n<0||Math.abs(n)<=1e4&&Math.abs(l)<=1e4&&l<200;if(a&&!o)return"spec_i";if(o&&!a)return"lsd_i"}return null}function r(){v.innerHTML="",Object.entries(E).forEach((([e,t])=>{const n=document.createElement("button");n.textContent=e,n.className="btn btn-sm btn-outline-primary m-1",n.addEventListener("click",(()=>s(t,e))),v.appendChild(n)})),v.style.display="none"}function s(e){if(!L)return;y.value=e.toFixed(2);const t=parseFloat(g.value);if(isNaN(t))return;const n=C(t,e);u([e-n,e+n])}function d(){if(!y)return;const e=document.createElement("button");e.type="button",e.id="wl0-jump-btn",e.textContent="jump",e.className="btn btn-sm btn-primary",e.style.marginLeft="8px",e.addEventListener("click",c),y.insertAdjacentElement("afterend",e)}function c(){if(!L)return void alert("Please load data first.");const e=parseFloat(y.value),t=parseFloat(g.value);if(!isFinite(e))return void alert("Invalid wl0.");if(!isFinite(t)||t<=0)return void alert("Invalid velocity range.");const n=C(t,e),l=[e-n,e+n],{data:a,xCol:o,resolvedType:i}=L;if(i&&i.startsWith("lsd")){const e=0,n=[e-t,e+t],l=a[o]||[],i=Math.min(...l),r=Math.max(...l);return n[1]>=i&&n[0]<=r||alert("Requested range is out of data bounds."),void u(n)}const r=a[o]||[];if(!r.length)return void alert("No x data found.");const s=Math.min(...r),d=Math.max(...r);l[1]>=s&&l[0]<=d||alert("Requested range is out of data bounds."),u(l)}function u(e=null){if("undefined"==typeof Plotly)return void(I.innerHTML="Plotly.js library not loaded.");if(!L){const e={layout:{title:"Please upload a data file",xaxis:{title:"Wavelength (nm) / Velocity (km/s)"},yaxis:{title:"Intensity"},height:500}};return void Plotly.newPlot(I,[],e.layout,{responsive:!0})}const{data:t,columns:n,xCol:l,resolvedType:a}=L,o=Array.from(x.querySelectorAll("input:checked")).map((e=>e.value)),i={N:n.filter((e=>["Null1","Null2","Null"].includes(e))),V:n.filter((e=>["Pol","V"].includes(e))),I:n.filter((e=>["Int"].includes(e)))},r={};Object.keys(i).forEach((e=>{const t=i[e].filter((e=>o.includes(e)));r[e]=t.length>0?t:i[e]}));const s={Int:"#1f77b4",Pol:"#d62728",V:"#d62728",Null:"#2ca02c",Null1:"#2ca02c",Null2:"#17becf",sigma_int:"#9467bd"},d=[],c=(e,n)=>{e.forEach((e=>{if(!t[e])return;[...new Set(t.order_id)].forEach((a=>{const o=t.order_id.reduce(((e,t,n)=>t===a?[...e,n]:e),[]);d.push({x:o.map((e=>t[l][e])),y:o.map((n=>t[e][n])),mode:"lines",name:e,yaxis:n,line:{color:s[e]||"#000000",width:1.5},legendgroup:e,showlegend:0===a})}))}))};c(r.N,"y3"),c(r.V,"y2"),c(r.I,"y");const u={grid:{rows:3,columns:1,pattern:"independent"},title:"Spectral Data",xaxis:{title:a.startsWith("spec")?"Wavelength (nm)":"Radial Velocity (km/s)",anchor:"y"},yaxis:{domain:[0,.6],title:"I"},yaxis2:{domain:[.62,.8],title:"V"},yaxis3:{domain:[.82,1],title:"N"},hovermode:"x unified",legend:{orientation:"h",y:-.2,x:.5,xanchor:"center"},margin:{l:60,r:30,b:80,t:50},height:600};if(e){u.xaxis.range=e;const n=(n,a)=>{let o=1/0,i=-1/0,r=!1;if(n.forEach((n=>{if(t[n])for(let a=0;a<t[l].length;a++)t[l][a]>=e[0]&&t[l][a]<=e[1]&&(o=Math.min(o,t[n][a]),i=Math.max(i,t[n][a]),r=!0)})),r){const e=.05*(i-o)||.05*Math.abs(o)||.1;u[a].range=[o-e,i+e]}};n(r.I,"yaxis"),n(r.V,"yaxis2"),n(r.N,"yaxis3")}Plotly.newPlot(I,d,u,{responsive:!0})}const m=document.getElementById("upload-data"),p=document.getElementById("upload-box"),f=document.getElementById("file-type-radios"),h=document.getElementById("resolved-type"),y=document.getElementById("wl0-input"),g=document.getElementById("vel-range"),v=document.getElementById("line-buttons-container"),x=document.getElementById("col-checklist"),I=document.getElementById("spectrum-figure");if(!m||!I)return;const E={"H-alpha 6563":656.28,"H-beta 4861":486.13,"H-gamma 4340":434.05,"H-delta 4102":410.17,"H-epsilon 3970":397.01,"H-zeta 3889":388.9064,"He I D3 5876":587.56,"He I 4472":447.15,"He I 4026":402.62,"He I 3889":388.86,"He II 4686":468.57038,"Na II D1 5890":588.995,"Na II D2 5896":589.592,"Ca II K 3934":393.37,"Ca II H 3969":396.85,"Ca II IRT-1 8498":849.8,"Ca II IRT-2 8542":854.21,"Ca II IRT-3 8662":866.21},b=299792.458,C=(e,t)=>t*e/b;let L=null;p.addEventListener("click",(()=>m.click())),m.addEventListener("change",(t=>e(t.target.files[0]))),p.addEventListener("dragover",(e=>{e.preventDefault(),p.classList.add("dragover")})),p.addEventListener("dragleave",(()=>p.classList.remove("dragover"))),p.addEventListener("drop",(t=>{t.preventDefault(),p.classList.remove("dragover"),e(t.dataTransfer.files[0])})),[y,g,f].forEach((e=>{e.addEventListener("change",t)})),x.addEventListener("change",(()=>u())),d(),r(),u()}));
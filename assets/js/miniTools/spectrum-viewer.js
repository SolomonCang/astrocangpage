document.addEventListener("DOMContentLoaded",(()=>{function e(e){if(!e)return;u.innerHTML=`Loading: <em>${e.name}</em>`,p.textContent="Processing...";const l=new FileReader;l.onload=n=>{t(n.target.result,e.name)},l.onerror=()=>{n("An error occurred while reading the file.")},l.readAsText(e)}function t(e,t=null){let a;if("string"!=typeof e)return C?void d():void 0;a=e;try{const e=document.querySelector('input[name="file-type"]:checked').value;C=o(a,e),l(t),d()}catch(e){n(e.message)}}function n(e){C=null,v.innerHTML=`<p style="color: red; text-align: center; padding: 20px;">Error: ${e}</p>`,p.textContent="Load failed",g.innerHTML="<small>Loading failed.</small>",u&&(u.innerHTML="Load failed, please try again. <a>Click to choose file</a>")}function l(e){if(!C)return;e&&(u.innerHTML=`Loaded: <em>${e}</em>. Drag or choose a new file to replace.`);const t={spec_pol:"Spec (pol)",spec_i:"Spec (I)",lsd_pol:"LSD (pol)",lsd_i:"LSD (I)"};p.textContent=t[C.resolvedType]||C.resolvedType,g.innerHTML="";const n=C.columns.filter((e=>e!==C.xCol&&"order_id"!==e)),l=["Int","Pol","Null1"];n.forEach((e=>{const t=document.createElement("div");t.style.display="inline-block",t.style.marginRight="15px";const n=document.createElement("input");n.type="checkbox",n.id=`col-${e}`,n.value=e,n.checked=l.includes(e);const o=document.createElement("label");o.htmlFor=`col-${e}`,o.textContent=e,t.appendChild(n),t.appendChild(o),g.appendChild(t)}));const o=C.resolvedType.startsWith("spec");y.style.display=o?"block":"none"}function o(e,t){const n=e.split("\n").filter((e=>!e.trim().startsWith("*")));let l=-1;for(let e=0;e<n.length;e++){if(n[e].trim().split(/\s+/).reduce(((e,t)=>e+(isFinite(t)&&""!==t?1:0)),0)>=3){l=e;break}}if(-1===l&&(l=n.findIndex((e=>e.trim().split(/\s+/).length>=2)),-1===l))throw new Error("Could not find valid data lines in the file.");const o=n.slice(l).map((e=>e.trim().split(/\s+/).map(parseFloat))).filter((e=>e.length>0&&!e.some(isNaN)));if(0===o.length)throw new Error("No valid data after parsing.");const r=o[0].length;let s,d,c;const u=e=>{const t=a(r,e);if(!t)throw new Error(`The file has ${r} columns, which does not match the requirements for the selected type ${e}.`);return{...t,resolvedType:e}};if("auto"===t){if(s=i(o),!s)throw new Error("Unable to automatically determine data type. Please select manually.");({columnNames:d,xCol:c}=u(s))}else({columnNames:d,xCol:c,resolvedType:s}=u(t));const m={};d.forEach((e=>m[e]=[])),o.forEach((e=>{for(let t=0;t<d.length;t++)void 0!==e[t]&&m[d[t]].push(e[t])}));const p=m[c];let f=-1/0,h=0;return m.order_id=p.map((e=>(e<f&&h++,f=e,h))),{data:m,columns:[...d,"order_id"],xCol:c,resolvedType:s}}function a(e,t){const n={spec_pol:{ncol:6,names:["Wav","Int","Pol","Null1","Null2","sigma_int"],xCol:"Wav"},spec_i:{ncol:3,names:["Wav","Int","sigma_int"],xCol:"Wav"},lsd_pol:{ncol:7,names:["RV","Int","sigma_int","Pol","sigma_pol","Null1","sigma_null1"],xCol:"RV"},lsd_i:{ncol:3,names:["RV","Int","sigma_int"],xCol:"RV"}}[t];return n&&n.ncol===e?{columnNames:n.names,xCol:n.xCol}:null}function i(e){if(!e||0===e.length)return null;const t=e[0].length;if(6===t)return"spec_pol";if(7===t)return"lsd_pol";if(3===t){const t=e.map((e=>e[0])),n=Math.min(...t),l=Math.max(...t),o=n>=200&&l<=5e3,a=n<0||Math.abs(n)<=1e4&&Math.abs(l)<=1e4&&l<200;if(o&&!a)return"spec_i";if(a&&!o)return"lsd_i"}return null}function r(){y.innerHTML="",Object.entries(I).forEach((([e,t])=>{const n=document.createElement("button");n.textContent=e,n.className="btn btn-sm btn-outline-primary m-1",n.addEventListener("click",(()=>s(t,e))),y.appendChild(n)})),y.style.display="none"}function s(e){if(!C)return;f.value=e.toFixed(2);const t=parseFloat(h.value);if(isNaN(t))return;const n=E(t,e);d([e-n,e+n])}function d(e=null){if("undefined"==typeof Plotly)return void(v.innerHTML="Plotly.js library not loaded.");if(!C){const e={layout:{title:"Please upload a data file",xaxis:{title:"Wavelength (nm) / Velocity (km/s)"},yaxis:{title:"Intensity"},height:500}};return void Plotly.newPlot(v,[],e.layout,{responsive:!0})}const{data:t,columns:n,xCol:l,resolvedType:o}=C,a=Array.from(g.querySelectorAll("input:checked")).map((e=>e.value)),i={N:n.filter((e=>["Null1","Null2","Null"].includes(e))),V:n.filter((e=>["Pol","V"].includes(e))),I:n.filter((e=>["Int"].includes(e)))},r={};Object.keys(i).forEach((e=>{const t=i[e].filter((e=>a.includes(e)));r[e]=t.length>0?t:i[e]}));const s={Int:"#1f77b4",Pol:"#d62728",V:"#d62728",Null:"#2ca02c",Null1:"#2ca02c",Null2:"#17becf",sigma_int:"#9467bd"},d=[],c=(e,n)=>{e.forEach((e=>{if(!t[e])return;[...new Set(t.order_id)].forEach((o=>{const a=t.order_id.reduce(((e,t,n)=>t===o?[...e,n]:e),[]);d.push({x:a.map((e=>t[l][e])),y:a.map((n=>t[e][n])),mode:"lines",name:e,yaxis:n,line:{color:s[e]||"#000000",width:1.5},legendgroup:e,showlegend:0===o})}))}))};c(r.N,"y3"),c(r.V,"y2"),c(r.I,"y");const u={grid:{rows:3,columns:1,pattern:"independent"},title:"Spectral Data",xaxis:{title:o.startsWith("spec")?"Wavelength (nm)":"Radial Velocity (km/s)",anchor:"y"},yaxis:{domain:[0,.6],title:"I"},yaxis2:{domain:[.62,.8],title:"V"},yaxis3:{domain:[.82,1],title:"N"},hovermode:"x unified",legend:{orientation:"h",y:-.2,x:.5,xanchor:"center"},margin:{l:60,r:30,b:80,t:50},height:600};if(e){u.xaxis.range=e;const n=(n,o)=>{let a=1/0,i=-1/0,r=!1;if(n.forEach((n=>{if(t[n])for(let o=0;o<t[l].length;o++)t[l][o]>=e[0]&&t[l][o]<=e[1]&&(a=Math.min(a,t[n][o]),i=Math.max(i,t[n][o]),r=!0)})),r){const e=.05*(i-a)||.05*Math.abs(a)||.1;u[o].range=[a-e,i+e]}};n(r.I,"yaxis"),n(r.V,"yaxis2"),n(r.N,"yaxis3")}Plotly.newPlot(v,d,u,{responsive:!0})}const c=document.getElementById("upload-data"),u=document.getElementById("upload-box"),m=document.getElementById("file-type-radios"),p=document.getElementById("resolved-type"),f=document.getElementById("wl0-input"),h=document.getElementById("vel-range"),y=document.getElementById("line-buttons-container"),g=document.getElementById("col-checklist"),v=document.getElementById("spectrum-figure");if(!c||!v)return;const I={"H-alpha 6563":656.28,"H-beta 4861":486.13,"H-gamma 4340":434.05,"H-delta 4102":410.17,"H-epsilon 3970":397.01,"H-zeta 3889":388.9064,"He I D3 5876":587.56,"He I 4472":447.15,"He I 4026":402.62,"He I 3889":388.86,"He II 4686":468.57038,"Na II D1 5890":588.995,"Na II D2 5896":589.592,"Ca II K 3934":393.37,"Ca II H 3969":396.85,"Ca II IRT-1 8498":849.8,"Ca II IRT-2 8542":854.21,"Ca II IRT-3 8662":866.21},x=299792.458,E=(e,t)=>t*e/x;let C=null;u.addEventListener("click",(()=>c.click())),c.addEventListener("change",(t=>e(t.target.files[0]))),u.addEventListener("dragover",(e=>{e.preventDefault(),u.classList.add("dragover")})),u.addEventListener("dragleave",(()=>u.classList.remove("dragover"))),u.addEventListener("drop",(t=>{t.preventDefault(),u.classList.remove("dragover"),e(t.dataTransfer.files[0])})),[f,h,m].forEach((e=>{e.addEventListener("change",t)})),g.addEventListener("change",(()=>d())),r(),d()}));
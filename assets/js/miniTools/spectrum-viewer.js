document.addEventListener("DOMContentLoaded",(()=>{function e(e){if(!e)return;p.innerHTML=`Loading: <em>${e.name}</em>`,h.textContent="Processing...";const l=new FileReader;l.onload=n=>{t(n.target.result,e.name)},l.onerror=()=>{n("An error occurred while reading the file.")},l.readAsText(e)}function t(e,t=null){let i;if("string"!=typeof e)return C?void m():void 0;i=e;try{const e=document.querySelector('input[name="file-type"]:checked').value;C=a(i,e),l(t),m()}catch(e){n(e.message)}}function n(e){C=null,I.innerHTML=`<p style="color: red; text-align: center; padding: 20px;">Error: ${e}</p>`,h.textContent="Load failed",x.innerHTML="<small>Loading failed.</small>",p&&(p.innerHTML="Load failed, please try again. <a>Click to choose file</a>")}function l(e){if(!C)return;e&&(p.innerHTML=`Loaded: <em>${e}</em>. Drag or choose a new file to replace.`);const t={spec_pol:"Spec (pol)",spec_i:"Spec (I)",spec_i_simple:"Spec (I, simple)",lsd_pol:"LSD (pol)",lsd_i:"LSD (I)",lsd_i_simple:"LSD (I, simple)"};h.textContent=t[C.resolvedType]||C.resolvedType,x.innerHTML="";const n=C.columns.filter((e=>e!==C.xCol&&"order_id"!==e)),l=["Int","Pol","Null1"];n.forEach((e=>{const t=document.createElement("div");t.style.display="inline-block",t.style.marginRight="15px";const n=document.createElement("input");n.type="checkbox",n.id=`col-${e}`,n.value=e,n.checked=l.includes(e);const a=document.createElement("label");a.htmlFor=`col-${e}`,a.textContent=e,t.appendChild(n),t.appendChild(a),x.appendChild(t)}));const a=C.resolvedType.startsWith("spec");v.style.display=a?"block":"none"}function a(e,t){const n=e.split("\n").filter((e=>!e.trim().startsWith("*")));let l=-1,a=0;for(let e=0;e<n.length;e++){if(n[e].trim().split(/\s+/).reduce(((e,t)=>e+(isFinite(t)&&""!==t?1:0)),0)>=2){l=e;break}}if(-1===l)throw new Error("Could not find valid data lines in the file.");const r=n[l].trim().split(/\s+/).map(parseFloat);2===r.length&&r.every((e=>isFinite(e)))&&(a=2);const s=n.slice(l+a).map((e=>e.trim().split(/\s+/).map(parseFloat))).filter((e=>e.length>0&&!e.some(isNaN)));if(0===s.length)throw new Error("No valid data after parsing.");const d=s[0].length;let c,m,u;const p=e=>{const t=i(d,e);if(!t)throw new Error(`The file has ${d} columns, which does not match the requirements for the selected type ${e}.`);return{...t,resolvedType:e}};if("auto"===t){if(c=o(s),!c)throw new Error("Unable to automatically determine data type. Please select manually.");({columnNames:m,xCol:u}=p(c))}else({columnNames:m,xCol:u,resolvedType:c}=p(t));const f={};m.forEach((e=>f[e]=[])),s.forEach((e=>{for(let t=0;t<m.length;t++)void 0!==e[t]&&f[m[t]].push(e[t])}));const h=f[u];let y=-1/0,g=0;return f.order_id=h.map((e=>(e<y&&g++,y=e,g))),{data:f,columns:[...m,"order_id"],xCol:u,resolvedType:c}}function i(e,t){const n={spec_pol:{ncol:6,names:["Wav","Int","Pol","Null1","Null2","sigma_int"],xCol:"Wav"},spec_i:{ncol:3,names:["Wav","Int","sigma_int"],xCol:"Wav"},spec_i_simple:{ncol:2,names:["Wav","Int"],xCol:"Wav"},lsd_pol:{ncol:7,names:["RV","Int","sigma_int","Pol","sigma_pol","Null1","sigma_null1"],xCol:"RV"},lsd_i:{ncol:3,names:["RV","Int","sigma_int"],xCol:"RV"},lsd_i_simple:{ncol:2,names:["RV","Int"],xCol:"RV"}}[t];return n&&n.ncol===e?{columnNames:n.names,xCol:n.xCol}:null}function o(e){if(!e||0===e.length)return null;const t=e[0].length;if(6===t)return"spec_pol";if(7===t)return"lsd_pol";if(3===t){const t=e.map((e=>e[0])),n=Math.min(...t),l=Math.max(...t),a=n>=200&&l<=5e3,i=n<0||Math.abs(n)<=1e4&&Math.abs(l)<=1e4&&l<200;if(a&&!i)return"spec_i";if(i&&!a)return"lsd_i"}if(2===t){const t=e.map((e=>e[0])),n=Math.min(...t),l=Math.max(...t),a=n>=200&&l<=5e3,i=n<0||Math.abs(n)<=1e4&&Math.abs(l)<=1e4&&l<200;if(a&&!i)return"spec_i_simple";if(i&&!a)return"lsd_i_simple"}return null}function r(){v.innerHTML="",Object.entries(E).forEach((([e,t])=>{const n=document.createElement("button");n.textContent=e,n.className="btn btn-sm btn-outline-primary m-1",n.addEventListener("click",(()=>s(t,e))),v.appendChild(n)})),v.style.display="none"}function s(e){if(!C)return;y.value=e.toFixed(2);const t=parseFloat(g.value);if(isNaN(t))return;const n=b(t,e);m([e-n,e+n])}function d(){if(!y)return;const e=document.createElement("button");e.type="button",e.id="wl0-jump-btn",e.textContent="jump",e.className="btn btn-sm btn-primary",e.style.marginLeft="8px",e.addEventListener("click",c),y.insertAdjacentElement("afterend",e)}function c(){if(!C)return void alert("Please load data first.");const e=parseFloat(y.value),t=parseFloat(g.value);if(!isFinite(e))return void alert("Invalid wl0.");if(!isFinite(t)||t<=0)return void alert("Invalid velocity range.");const n=b(t,e),l=[e-n,e+n],{data:a,xCol:i,resolvedType:o}=C;if(o&&o.startsWith("lsd")){const e=0,n=[e-t,e+t],l=a[i]||[],o=Math.min(...l),r=Math.max(...l);return n[1]>=o&&n[0]<=r||alert("Requested range is out of data bounds."),void m(n)}const r=a[i]||[];if(!r.length)return void alert("No x data found.");const s=Math.min(...r),d=Math.max(...r);l[1]>=s&&l[0]<=d||alert("Requested range is out of data bounds."),m(l)}function m(e=null){if("undefined"==typeof Plotly)return void(I.innerHTML="Plotly.js library not loaded.");if(!C){const e={layout:{title:"Please upload a data file",xaxis:{title:"Wavelength (nm) / Velocity (km/s)"},yaxis:{title:"Intensity"},height:500}};return void Plotly.newPlot(I,[],e.layout,{responsive:!0})}const{data:t,columns:n,xCol:l,resolvedType:a}=C,i=Array.from(x.querySelectorAll("input:checked")).map((e=>e.value)),o={N:n.filter((e=>["Null1","Null2","Null"].includes(e))),V:n.filter((e=>["Pol","V"].includes(e))),I:n.filter((e=>["Int"].includes(e)))},r={};Object.keys(o).forEach((e=>{const t=o[e].filter((e=>i.includes(e)));r[e]=t.length>0?t:o[e]}));const s={Int:"#1f77b4",Pol:"#d62728",V:"#d62728",Null:"#2ca02c",Null1:"#2ca02c",Null2:"#17becf",sigma_int:"#9467bd"},d=[],c=(e,n)=>{e.forEach((e=>{if(!t[e])return;[...new Set(t.order_id)].forEach((a=>{const i=t.order_id.reduce(((e,t,n)=>t===a?[...e,n]:e),[]);d.push({x:i.map((e=>t[l][e])),y:i.map((n=>t[e][n])),mode:"lines",name:e,yaxis:n,line:{color:s[e]||"#000000",width:1.5},legendgroup:e,showlegend:0===a})}))}))};if(a.includes("_simple")){c(r.I,"y");const n={title:"Spectral Data",xaxis:{title:a.startsWith("spec")?"Wavelength (nm)":"Radial Velocity (km/s)"},yaxis:{title:"I"},hovermode:"x unified",legend:{orientation:"h",y:-.15,x:.5,xanchor:"center"},margin:{l:60,r:30,b:80,t:50},height:400};if(e){n.xaxis.range=e;let a=1/0,i=-1/0,o=!1;if(r.I.forEach((n=>{if(t[n])for(let r=0;r<t[l].length;r++)t[l][r]>=e[0]&&t[l][r]<=e[1]&&(a=Math.min(a,t[n][r]),i=Math.max(i,t[n][r]),o=!0)})),o){const e=.05*(i-a)||.05*Math.abs(a)||.1;n.yaxis.range=[a-e,i+e]}}Plotly.newPlot(I,d,n,{responsive:!0})}else{c(r.N,"y3"),c(r.V,"y2"),c(r.I,"y");const n={grid:{rows:3,columns:1,pattern:"independent"},title:"Spectral Data",xaxis:{title:a.startsWith("spec")?"Wavelength (nm)":"Radial Velocity (km/s)",anchor:"y"},yaxis:{domain:[0,.6],title:"I"},yaxis2:{domain:[.62,.8],title:"V"},yaxis3:{domain:[.82,1],title:"N"},hovermode:"x unified",legend:{orientation:"h",y:-.2,x:.5,xanchor:"center"},margin:{l:60,r:30,b:80,t:50},height:600};if(e){n.xaxis.range=e;const a=(a,i)=>{let o=1/0,r=-1/0,s=!1;if(a.forEach((n=>{if(t[n])for(let a=0;a<t[l].length;a++)t[l][a]>=e[0]&&t[l][a]<=e[1]&&(o=Math.min(o,t[n][a]),r=Math.max(r,t[n][a]),s=!0)})),s){const e=.05*(r-o)||.05*Math.abs(o)||.1;n[i].range=[o-e,r+e]}};a(r.I,"yaxis"),a(r.V,"yaxis2"),a(r.N,"yaxis3")}Plotly.newPlot(I,d,n,{responsive:!0})}}const u=document.getElementById("upload-data"),p=document.getElementById("upload-box"),f=document.getElementById("file-type-radios"),h=document.getElementById("resolved-type"),y=document.getElementById("wl0-input"),g=document.getElementById("vel-range"),v=document.getElementById("line-buttons-container"),x=document.getElementById("col-checklist"),I=document.getElementById("spectrum-figure");if(!u||!I)return;const E={"H-alpha 6563":656.28,"H-beta 4861":486.13,"H-gamma 4340":434.05,"H-delta 4102":410.17,"H-epsilon 3970":397.01,"H-zeta 3889":388.9064,"He I 10830":1083,"He I D3 5876":587.56,"He I 4472":447.15,"He I 4026":402.62,"He I 3889":388.86,"He II 4686":468.57038,"Na II D1 5890":588.995,"Na II D2 5896":589.592,"Ca II K 3934":393.37,"Ca II H 3969":396.85,"Ca II IRT-1 8498":849.8,"Ca II IRT-2 8542":854.21,"Ca II IRT-3 8662":866.21},_=299792.458,b=(e,t)=>t*e/_;let C=null;p.addEventListener("click",(()=>u.click())),u.addEventListener("change",(t=>e(t.target.files[0]))),p.addEventListener("dragover",(e=>{e.preventDefault(),p.classList.add("dragover")})),p.addEventListener("dragleave",(()=>p.classList.remove("dragover"))),p.addEventListener("drop",(t=>{t.preventDefault(),p.classList.remove("dragover"),e(t.dataTransfer.files[0])})),[y,g,f].forEach((e=>{e.addEventListener("change",t)})),x.addEventListener("change",(()=>m())),d(),r(),m()}));
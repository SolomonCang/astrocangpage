!function(){function t(){const t=d("invertY");return!(!t||!t.checked)}function e(t){return t.includes(",")?",":/\t/.test(t)?"\t":t.includes(";")?";":t.trim().split(/\s+/).length>1?"space":" "}function n(t,{sep:n="auto",hasHeader:o=!1,colMap:r="t,y,s"}){const a=t.split(/\r?\n/).filter((t=>t&&!t.trim().startsWith("#")));if(0===a.length)return{t:[],y:[],s:[]};let s="auto"===n?e(a[0]):n;"tab"===s&&(s="\t"),"space"===s&&(s="space");const i=r.split(","),l=[],c=[],f=[];for(let t=o?1:0;t<a.length;t++){const e=a[t].trim();if(!e||e.startsWith("#"))continue;const n="space"===s?e.split(/\s+/):e.split(s);if(n.length<2)continue;const o=n.map((t=>Number(t)));if(o.some((t=>Number.isNaN(t))))continue;let r,m,h;"y,t"===i.join(",")?(m=o[0],r=o[1],h=o[2]):(r=o[0],m=o[1],h=o[2]),l.push(r),c.push(m),void 0!==h&&f.push(h)}return{t:l,y:c,s:f}}function o(t){if(0===t.length)return{T:0,tmin:NaN,tmax:NaN,dtmin:NaN};let e=1/0,n=-1/0;for(const o of t)o<e&&(e=o),o>n&&(n=o);let o=1/0;for(let e=1;e<t.length;e++){const n=t[e]-t[e-1];n>0&&n<o&&(o=n)}const r=n-e;return{T:r,tmin:e,tmax:n,dtmin:isFinite(o)?o:r>0?r/t.length:NaN}}function r(t){let e=0;for(const n of t)e+=n;return e/t.length}function a(t,e){const n=t.length;let o=0,r=0,a=0,s=0;for(let i=0;i<n;i++){const n=t[i],l=e[i];o+=n,r+=l,a+=n*n,s+=n*l}const i=n*a-o*o;let l=0,c=0;Math.abs(i)>1e-24?(c=(n*s-o*r)/i,l=(r-c*o)/n):(l=r/n,c=0);const f=new Float64Array(n);for(let o=0;o<n;o++)f[o]=e[o]-(l+c*t[o]);return f}function s(t,e,n,r){const{T:a,dtmin:s}=o(t),i=e>0?e:Math.max(1/(a||1),1e-6),l=n>0?n:Math.max(.5/Math.max(s,1e-12),2*i),c=Math.max(16,Math.floor(Math.max(1,r)*a*(l-i))),f=new Float64Array(c),m=(l-i)/(c-1);for(let t=0;t<c;t++)f[t]=i+m*t;return{freqs:f,fmin:i,fmax:l}}function i(t,e,n,o,r,a,s="scargle"){const i=t.length;let l;if(n){let t=0;for(let o=0;o<i;o++){const r=n[o],a=e[o];t+=r*a*a}l=t}else{l=0;for(let t=0;t<i;t++)l+=e[t]*e[t]}const c=new Float64Array(a-r);for(let f=r;f<a;f++){const a=2*Math.PI*o[f];let m=0,h=0;for(let e=0;e<i;e++){const o=a*t[e],r=n?n[e]:1;m+=Math.sin(2*o)*r,h+=Math.cos(2*o)*r}const u=.5*Math.atan2(m,h)/Math.max(a,1e-30);let p=0,d=0,y=0,g=0;for(let o=0;o<i;o++){const r=n?n[o]:1,s=a*(t[o]-u),i=Math.cos(s),l=Math.sin(s);p+=r*i*i,d+=r*l*l,y+=r*e[o]*i,g+=r*e[o]*l}let w=.5*(y*y/Math.max(p,1e-24)+g*g/Math.max(d,1e-24))/Math.max(l/2,1e-24);"psd"===s&&(w=(y*y/Math.max(p,1e-24)+g*g/Math.max(d,1e-24))/Math.max(i,1e-24)),c[f-r]=w}return c}function l(){const e=t();if(0===x.t.length)return void Plotly.newPlot("timePlot",[{x:[0],y:[0],mode:"markers",visible:"legendonly"}],{paper_bgcolor:"#ffffff",plot_bgcolor:"#ffffff",margin:{l:50,r:10,t:10,b:40},xaxis:{title:"t",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"},yaxis:{title:"y",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2",autorange:!e||"reversed"}},{responsive:!0});const n={x:x.t,y:x.y,mode:"markers",marker:{color:"#3aa0ff",size:6,opacity:.8},name:"y(t)"},o={paper_bgcolor:"#ffffff",plot_bgcolor:"#ffffff",margin:{l:50,r:10,t:10,b:40},xaxis:{title:"t",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"},yaxis:{title:"y",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2",autorange:!e||"reversed"}};Plotly.newPlot("timePlot",[n],o,{responsive:!0})}function c(t,e,n){const o={x:Array.from(t),y:Array.from(e),mode:"lines",line:{color:"#18a999"},name:"L-S Power"},r=[],a=[];if(n>=0&&t.length&&e.length){const o=t[n],s=e[n];r.push({type:"line",x0:o,x1:o,y0:0,y1:s,line:{color:"#ff6b6b",width:2,dash:"dot"}}),a.push({x:o,y:s,text:`peak f=${o.toPrecision(5)} (P=${(1/o).toPrecision(5)})`,yanchor:"bottom",showarrow:!0,arrowhead:3,ax:20,ay:-20,font:{color:"#a33"}})}const s={paper_bgcolor:"#ffffff",plot_bgcolor:"#ffffff",margin:{l:50,r:10,t:10,b:40},xaxis:{title:"Frequency",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"},yaxis:{title:"Power",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"},shapes:r,annotations:a};Plotly.newPlot("lsPlot",[o],s,{responsive:!0})}function f(t,e,n=1){if(0===x.t.length||!isFinite(t)||t<=0)return void Plotly.newPlot("phasePlot",[{x:[0],y:[0],visible:"legendonly"}],{paper_bgcolor:"#ffffff",plot_bgcolor:"#ffffff"});const o=[],r=[];for(let n=0;n<x.t.length;n++){const a=(x.t[n]-e)/t%1,s=a<0?a+1:a;o.push(s),r.push(x.y[n])}const a=[{x:o,y:r,mode:"markers",marker:{color:"#e1b12c",size:6,opacity:.85},name:"phase"}];if(2===n){const t=o.map((t=>t+1));a.push({x:t,y:r,mode:"markers",marker:{color:"#e1b12c",size:6,opacity:.35},name:"phase+1",showlegend:!1})}const s={paper_bgcolor:"#ffffff",plot_bgcolor:"#ffffff",margin:{l:50,r:10,t:10,b:40},xaxis:{title:"Phase",range:[0,n],gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"},yaxis:{title:"y",gridcolor:"#e6ebf2",zerolinecolor:"#e6ebf2"}};Plotly.newPlot("phasePlot",a,s,{responsive:!0})}async function m(){if(x.t.length<3)return void p("Not enough data");const t=Float64Array.from(x.t),e=Float64Array.from(x.y),n=d("useSigma").checked&&x.s.length===x.t.length,i=d("detrend").value,l=d("norm").value;let m;if("lin"===i)m=a(t,e);else{const t=r(e);m=Float64Array.from(e,(e=>e-t))}let h=null;if(n){h=new Float64Array(x.s.length);for(let t=0;t<h.length;t++){const e=x.s[t];h[t]=e>0?1/(e*e):0}}b=h;const u=Math.max(1,parseInt(d("ofac").value||"5",10)),g=parseFloat(d("fmin").value),M=parseFloat(d("fmax").value),{freqs:v,fmin:k,fmax:F}=s(t,g,M,u);y("nf",v.length.toLocaleString());const N=(d("nWorkers").value||"").trim().toLowerCase(),A=navigator.hardwareConcurrency||4,C="navigator"===N?Math.min(8,Math.max(1,A)):Math.max(1,parseInt(N||"2",10)),q=v.length,I=Math.ceil(q/C),S=[];let L=0;for(;L<q;)S.push({start:L,end:Math.min(q,L+I)}),L+=I;p(`Computing: M=${q}, workers=${C}, f in [${k.toPrecision(5)}, ${F.toPrecision(5)}]`);const Y=new Float64Array(q),$=[],z=[];for(const e of S){const n=new Worker(w);$.push(n),z.push(new Promise((t=>{n.onmessage=e=>{const{start:n,end:o,P:r}=e.data;Y.set(new Float64Array(r),n),t()}}))),n.postMessage({t:new Float64Array(t),y0:new Float64Array(m),w:h?new Float64Array(h):null,freqs:new Float64Array(v),start:e.start,end:e.end,norm:l})}await Promise.all(z),$.forEach((t=>t.terminate()));let _=0;for(let t=1;t<Y.length;t++)Y[t]>Y[_]&&(_=t);P={freqs:v,P:Y,peakIndex:_};const E=v[_],R=Y[_];y("peakF",isFinite(E)?E.toPrecision(8):"-"),y("peakP",isFinite(R)?R.toPrecision(6):"-"),y("peakPer",isFinite(E)?(1/E).toPrecision(8):"-"),c(v,Y,_);const T=d("period");if(!T.value){const t=1/E;T.value=isFinite(t)?t:""}const D=Number.isFinite(Number(d("t0").value))?Number(d("t0").value):o(x.t).tmin,W=Number(T.value);f(d("mirrorPeriod").checked?W/2:W,D,parseInt(d("phaseRepeat").value,10)),p("Done")}function h(){if(!P.freqs.length)return void p("Compute L-S first");const t=P.freqs,e=t[P.peakIndex>=0?P.peakIndex:0],n=(t[t.length-1]-t[0])/t.length,s=20,l=Math.max(1e-9,e-s*n),m=e+s*n,h=20*s,u=new Float64Array(h),g=(m-l)/Math.max(1,h-1);for(let t=0;t<h;t++)u[t]=l+t*g;const w=Float64Array.from(x.t),M=Float64Array.from(x.y);let v;if("lin"===d("detrend").value)v=a(w,M);else{const t=r(M);v=Float64Array.from(M,(e=>e-t))}const k=d("useSigma").checked&&x.s.length===x.t.length?Float64Array.from(b):null,F=d("norm").value,N=i(w,v,k,u,0,u.length,F);let A=0;for(let t=1;t<N.length;t++)N[t]>N[A]&&(A=t);const C=u[A],q=N[A];c(u,N,A),y("peakF",isFinite(C)?C.toPrecision(8):"-"),y("peakP",isFinite(q)?q.toPrecision(6):"-"),y("peakPer",isFinite(C)?(1/C).toPrecision(8):"-");d("period").value=1/C;const I=Number.isFinite(Number(d("t0").value))?Number(d("t0").value):o(x.t).tmin;f(d("mirrorPeriod").checked?1/C/2:1/C,I,parseInt(d("phaseRepeat").value,10)),p("Refined around peak")}function u(){y("statN",x.t.length);const{T:t,tmin:e,tmax:n,dtmin:r}=o(x.t);y("statT",isFinite(t)?`${e.toPrecision(5)} ~ ${n.toPrecision(5)} (T=${t.toPrecision(5)})`:"-"),y("statDt",isFinite(r)?r.toPrecision(5):"-")}function p(t){const e=d("log");if(!e)return;const n=(new Date).toLocaleTimeString();e.textContent=`[${n}] ${t}\n`+e.textContent}const d=t=>document.getElementById(t),y=(t,e)=>{const n=d(t);n&&(n.textContent=e)},g=new Blob(["\n    self.onmessage = (e) => {\n      const {t, y0, w, freqs, start, end, norm} = e.data;\n      function chunk(t, y0, w, freqs, start, end, norm){\n        const n = t.length;\n        let yy;\n        if (w) { let num=0; for (let i=0;i<n;i++){ const wi=w[i]; const d=y0[i]; num += wi*d*d; } yy = num; }\n        else { yy = 0; for (let i=0;i<n;i++) yy += y0[i]*y0[i]; }\n        const P = new Float64Array(end - start);\n        for (let k=start; k<end; k++){\n          const wfreq = 2*Math.PI*freqs[k];\n          let s2=0, c2=0;\n          for (let i=0;i<n;i++){\n            const wt = wfreq*t[i];\n            const wi = w ? w[i] : 1;\n            s2 += Math.sin(2*wt) * wi;\n            c2 += Math.cos(2*wt) * wi;\n          }\n          const tau = 0.5*Math.atan2(s2, c2)/Math.max(wfreq,1e-30);\n          let C=0,S=0,YC=0,YS=0;\n          for (let i=0;i<n;i++){\n            const wi = w ? w[i] : 1;\n            const wt = wfreq*(t[i]-tau);\n            const c = Math.cos(wt), s = Math.sin(wt);\n            C += wi*c*c; S += wi*s*s; YC += wi*y0[i]*c; YS += wi*y0[i]*s;\n          }\n          let Pk = 0.5 * ((YC*YC)/Math.max(C,1e-24) + (YS*YS)/Math.max(S,1e-24)) / Math.max(yy/2,1e-24);\n          if (norm === 'psd') Pk = ((YC*YC)/Math.max(C,1e-24) + (YS*YS)/Math.max(S,1e-24)) / Math.max(n,1e-24);\n          P[k - start] = Pk;\n        }\n        return P;\n      }\n      const P = chunk(t, y0, w, freqs, start, end, norm);\n      self.postMessage({start, end, P}, [P.buffer]);\n    };\n  "],{type:"application/javascript"}),w=URL.createObjectURL(g);let x={t:[],y:[],s:[]},P={freqs:new Float64Array(0),P:new Float64Array(0),peakIndex:-1},b=null;const M=d("fileInput");M&&M.addEventListener("change",(async t=>{const e=t.target.files&&t.target.files[0];if(!e)return;const o=n(await e.text(),{sep:d("sep").value,hasHeader:d("hasHeader").checked,colMap:d("colMap").value});if(0===o.t.length)return void p("No valid rows parsed");const r=o.t.map(((t,e)=>[t,e])).sort(((t,e)=>t[0]-e[0])).map((t=>t[1]));x.t=r.map((t=>o.t[t])),x.y=r.map((t=>o.y[t])),x.s=o.s.length?r.map((t=>o.s[t])):[],u(),l(),p(`Loaded ${x.t.length} points`)}));const v=d("btnClear");v&&v.addEventListener("click",(()=>{x={t:[],y:[],s:[]},P={freqs:new Float64Array(0),P:new Float64Array(0),peakIndex:-1},M&&(M.value=""),u(),l(),c(new Float64Array(0),new Float64Array(0),-1),f(NaN,0,1),y("peakF","-"),y("peakP","-"),y("peakPer","-"),y("nf","0"),p("Cleared")}));const k=d("btnDemo");k&&k.addEventListener("click",(()=>{const t=300,e=1.2345,n=1,o=.25,r=[];let a=0;for(let e=0;e<t;e++)a+=.01+.05*Math.random(),r.push(a+(Math.random()<.1?.2*Math.random():0));const s=r.map((t=>n*Math.sin(2*Math.PI*t/e+.4)+(2*Math.random()-1)*o));x={t:r,y:s,s:[]},u(),l(),p(`Demo generated: N=${t}, true P~${e}`)}));const F=d("btnCompute");F&&F.addEventListener("click",(()=>m()));const N=d("btnRefine");N&&N.addEventListener("click",(()=>h()));const A=d("btnPhase");A&&A.addEventListener("click",(()=>{const t=parseFloat(d("period").value),e=Number.isFinite(Number(d("t0").value))?Number(d("t0").value):o(x.t).tmin,n=isFinite(t)?t:P.peakIndex>=0?1/P.freqs[P.peakIndex]:NaN;f(d("mirrorPeriod").checked?n/2:n,e,parseInt(d("phaseRepeat").value,10))}));const C=d("invertY");C&&C.addEventListener("change",(()=>{l()})),l(),c(new Float64Array(0),new Float64Array(0),-1),f(NaN,0,1)}();
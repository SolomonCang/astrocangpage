document.addEventListener("DOMContentLoaded",(()=>{function e(t,n){if(t&&null!=n)if(n instanceof Node)t.appendChild(n);else if("string"!=typeof n)if(Array.isArray(n)){const r=document.createDocumentFragment();for(const t of n)e(r,t);t.appendChild(r)}else t.appendChild(document.createTextNode(String(n)));else t.appendChild(document.createTextNode(n))}function t(t,n){t&&(t.innerHTML="",e(t,n))}function n(e,t,n){const r=new Uint8Array(e.buffer,t,n);let i="";for(let e=0;e<r.length;e++)i+=String.fromCharCode(r[e]);return i}function r(e){const t=2880;return Math.ceil(e/t)*t}function i(e,t){const i=[];let o=t;const s=2880,d=80;let a=!1;for(;!(a||o+s>e.byteLength);){const t=n(e,o,s);for(let e=0;e<s;e+=d){const n=t.slice(e,e+d),r=n.slice(0,8).trim(),o=n.slice(8,80);if("END"===r){i.push({keyword:"END",value:"",comment:""}),a=!0;break}if(0===n.trim().length)continue;if("COMMENT"===r||"HISTORY"===r){i.push({keyword:r,value:"",comment:n.slice(8).trim()});continue}let s="",l="";if(o.startsWith("=")){let e=o.slice(1).trimStart(),t=e,n="";if(e.includes("/")){let r=!1,i=-1;for(let t=0;t<e.length;t++){const n=e[t];if("'"===n&&(r=!r),"/"===n&&!r){i=t;break}}i>=0&&(t=e.slice(0,i).trimEnd(),n=e.slice(i+1).trim())}t=t.trim(),s=t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1).replace(/''/g,"'"):t,l=n}else s=o.trim();i.push({keyword:r,value:s,comment:l})}o+=s}return{cards:i,nextOffset:r(o)}}function o(e,t=0){const n=parseInt(String(e??"").trim(),10);return Number.isFinite(n)?n:t}function s(e,t,n){if(t<=0)return 0;const i=n.reduce(((e,t)=>e*(t||0)),1)*(Math.abs(e)/8);return!Number.isFinite(i)||i<=0?0:r(i)}function d(e){const t={};for(const n of e||[])n.keyword&&"END"!==n.keyword&&"COMMENT"!==n.keyword&&"HISTORY"!==n.keyword&&(n.keyword in t||(t[n.keyword]=n.value));return t}function a(e){const t=String(e.XTENSION||"").toUpperCase();return t?t.includes("IMAGE")?"ImageHDU":t.includes("BINTABLE")?"BinTableHDU":t.includes("TABLE")?"TableHDU":t||"ExtensionHDU":void 0!==e.SIMPLE?"PrimaryHDU":"UnknownHDU"}function l(e){const t=new DataView(e),n=[];let l=0,c=0;for(;l<t.byteLength;){const{cards:e,nextOffset:u}=i(t,l);if(!e||0===e.length)break;const f=d(e),m=o(f.BITPIX,0),h=o(f.NAXIS,0),p=[];for(let e=1;e<=h;e++)p.push(o(f["NAXIS"+e],0));let g=s(m,h,p);0!==h||Number.isFinite(g)&&0!==g||(g=0);const v=r(u+g),y=a(f),E=String(f.EXTNAME||f.HDUNAME||"").trim(),x=f.EXTVER?o(f.EXTVER,null):null,L=p.length?"("+p.join(", ")+")":"None",b=(e||[]).map((e=>[e.keyword,String(e.value??""),String(e.comment??"")]));if(n.push({index:c,name:E,type:y,ver:x,data_shape:L,bitpix:m||null,naxis:h||null,headerRows:b}),c+=1,l=v,l<=0||l>=t.byteLength)break}return n}function c(e){t(b,y("div",{class:"error"},String(e))),C&&(C.style.display="none"),T&&(T.innerHTML=""),w&&(w.innerHTML="")}function u(e){b&&(b.textContent=String(e))}function f(){C&&S&&N&&(D.hdus.length?(C.style.display="block",S.innerHTML="",D.hdus.forEach((e=>{const t=`[${e.index}] ${e.type}  name='${e.name}'  shape=${e.data_shape}`,n=y("option",{value:String(e.index),text:t});S.appendChild(n)})),S.value=String(D.selected??0),N.textContent=`HDU count: ${D.hdus.length}`):C.style.display="none")}function m(){if(!T)return;if(!D.hdus.length)return void(T.innerHTML="");const t=["index","name","type","ver","data_shape","bitpix","naxis"],n=D.hdus.map((e=>[e.index,e.name,e.type,e.ver,e.data_shape,e.bitpix,e.naxis]));T.innerHTML="",e(T,y("h4",{},"HDU Overview")),e(T,E(t,n,{filterable:!1}))}function h(){if(!w)return;if(!D.hdus.length)return void(w.textContent="No HDU selected.");const t=D.selected??0,n=D.hdus.find((e=>e.index===Number(t)));n?(w.innerHTML="",e(w,y("h4",{},`HDU ${n.index} Header`)),e(w,E(["KEYWORD","VALUE","COMMENT"],n.headerRows,{filterable:!0}))):w.textContent="HDU index out of range."}function p(e){if(!e||e<=0)return"0 B";const t=["B","KB","MB","GB","TB"];let n=0,r=e;for(;r>=1024&&n<t.length-1;)r/=1024,n++;return r.toFixed(r>=100?0:r>=10?1:2)+" "+t[n]}function g(e){const t=String(e||"").toLowerCase();return H.some((e=>t.endsWith(e)))}function v(e){if(!e)return;if(!g(e.name))return void c(`Unsupported file: ${e.name}. Only .fits/.fit/.fts are allowed.`);x.classList.remove("dragover"),u(`Loading: ${e.name} ...`);const t=new FileReader;t.onload=()=>{try{const n=l(t.result);D.filename=e.name,D.hdus=n,D.selected=0,u(`Loaded: ${e.name} | Size: ${p(e.size)} | HDUs: ${n.length}`),f(),m(),h()}catch(e){c(`Parse failed: ${e?.message||e}`)}},t.onerror=()=>c("Failed to read file."),t.readAsArrayBuffer(e)}const y=(t,n={},r=[])=>{const i=document.createElement(t);for(const[e,t]of Object.entries(n))null!=t&&("class"===e?i.className=String(t):"text"===e?i.textContent=String(t):i.setAttribute(e,String(t)));const o=Array.isArray(r)?r:[r];for(const t of o)e(i,t);return i},E=(t,n,r={})=>{const i=y("div"),o=y("table"),s=y("thead"),d=y("tr");(t||[]).forEach(((e,t)=>{const n=y("th",{"data-idx":String(t),title:"Click to sort"},e??"");d.appendChild(n)})),s.appendChild(d);const a=y("tbody"),l=e=>{a.innerHTML="";for(const n of e||[]){const e=document.createElement("tr");for(let r=0;r<(t||[]).length;r++){const t=document.createElement("td");t.textContent=n&&null!=n[r]?String(n[r]):"",e.appendChild(t)}a.appendChild(e)}};l(n||[]);let c={idx:-1,dir:1};s.addEventListener("click",(e=>{const t=e.target.closest("th");if(!t)return;const r=+t.dataset.idx;c.idx===r?c.dir*=-1:(c.idx=r,c.dir=1);const i=[...n||[]].sort(((e,t)=>{const n=e?.[r],i=t?.[r],o=Number(n),s=Number(i);return(Number.isFinite(o)&&Number.isFinite(s)?o-s:String(n??"").localeCompare(String(i??"")))*c.dir}));l(i)})),o.appendChild(s),o.appendChild(a);const u=y("div",{class:"table-wrap"},o);if(r.filterable){const t=y("div",{class:"toolbar"},[y("span",{},"Filter:"),y("input",{type:"text",placeholder:"Enter keyword (applies to all columns)"})]),r=t.querySelector("input"),o=(n||[]).slice();r.addEventListener("input",(()=>{const e=r.value.trim().toLowerCase();if(!e)return void l(o);const t=o.filter((t=>(t||[]).some((t=>String(t).toLowerCase().includes(e)))));l(t)})),e(i,t)}return e(i,u),i},x=document.getElementById("uploader"),L=document.getElementById("fhv-file-input"),b=document.getElementById("fhv-file-info"),C=document.getElementById("fhv-controls"),S=document.getElementById("fhv-hdu-select"),N=document.getElementById("fhv-hdu-count"),T=document.getElementById("fhv-summary"),w=document.getElementById("fhv-header");if(!x||!L)return;const H=[".fits",".fit",".fts"];let D={filename:null,hdus:[],selected:0};x.addEventListener("click",(()=>L.click())),L.addEventListener("change",(e=>v(e.target.files&&e.target.files[0]))),x.addEventListener("dragover",(e=>{e.preventDefault(),x.classList.add("dragover")})),x.addEventListener("dragleave",(e=>{e.preventDefault(),x.classList.remove("dragover")})),x.addEventListener("drop",(e=>{e.preventDefault(),x.classList.remove("dragover");v(e.dataTransfer.files&&e.dataTransfer.files[0])})),S&&S.addEventListener("change",(e=>{D.selected=Number(e.target.value),h()}))}));
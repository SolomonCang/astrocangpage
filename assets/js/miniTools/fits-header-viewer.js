document.addEventListener("DOMContentLoaded",(()=>{function e(t,n){if(t&&null!=n)if(n instanceof Node)t.appendChild(n);else if("string"!=typeof n)if(Array.isArray(n)){const r=document.createDocumentFragment();for(const t of n)e(r,t);t.appendChild(r)}else t.appendChild(document.createTextNode(String(n)));else t.appendChild(document.createTextNode(n))}function t(t,n){t&&(t.innerHTML="",e(t,n))}function n(e,t,n){const r=new Uint8Array(e.buffer,t,n);let i="";for(let e=0;e<r.length;e++)i+=String.fromCharCode(r[e]);return i}function r(e){const t=2880;return Math.ceil(e/t)*t}function i(e,t){const i=[];let o=t;const s=2880,d=80;let a=!1;for(;!(a||o+s>e.byteLength);){const t=n(e,o,s);for(let e=0;e<s;e+=d){const n=t.slice(e,e+d),r=n.slice(0,8).trim(),o=n.slice(8,80);if("END"===r){i.push({keyword:"END",value:"",comment:""}),a=!0;break}if(0===n.trim().length)continue;if("COMMENT"===r||"HISTORY"===r){i.push({keyword:r,value:"",comment:n.slice(8).trim()});continue}let s="",l="";if(o.startsWith("=")){let e=o.slice(1).trimStart(),t=e,n="";if(e.includes("/")){let r=!1,i=-1;for(let t=0;t<e.length;t++){const n=e[t];if("'"===n&&(r=!r),"/"===n&&!r){i=t;break}}i>=0&&(t=e.slice(0,i).trimEnd(),n=e.slice(i+1).trim())}t=t.trim(),s=t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1).replace(/''/g,"'"):t,l=n}else s=o.trim();i.push({keyword:r,value:s,comment:l})}o+=s}return{cards:i,nextOffset:r(o)}}function o(e,t=0){const n=parseInt(String(e??"").trim(),10);return Number.isFinite(n)?n:t}function s(e,t,n){if(t<=0)return 0;const i=n.reduce(((e,t)=>e*(t||0)),1)*(Math.abs(e)/8);return!Number.isFinite(i)||i<=0?0:r(i)}function d(e){const t={};for(const n of e||[])n.keyword&&"END"!==n.keyword&&"COMMENT"!==n.keyword&&"HISTORY"!==n.keyword&&(n.keyword in t||(t[n.keyword]=n.value));return t}function a(e){const t=String(e.XTENSION||"").toUpperCase();return t?t.includes("IMAGE")?"ImageHDU":t.includes("BINTABLE")?"BinTableHDU":t.includes("TABLE")?"TableHDU":t||"ExtensionHDU":void 0!==e.SIMPLE?"PrimaryHDU":"UnknownHDU"}function l(e){const t=new DataView(e),n=[];let l=0,c=0;for(;l<t.byteLength;){const{cards:e,nextOffset:u}=i(t,l);if(!e||0===e.length)break;const f=d(e),m=o(f.BITPIX,0),h=o(f.NAXIS,0),p=[];for(let e=1;e<=h;e++)p.push(o(f["NAXIS"+e],0));let g=s(m,h,p);0!==h||Number.isFinite(g)&&0!==g||(g=0);const v=r(u+g),y=a(f),E=String(f.EXTNAME||f.HDUNAME||"").trim(),b=f.EXTVER?o(f.EXTVER,null):null,x=p.length?"("+p.join(", ")+")":"None",L=(e||[]).map((e=>[e.keyword,String(e.value??""),String(e.comment??"")]));if(n.push({index:c,name:E,type:y,ver:b,data_shape:x,bitpix:m||null,naxis:h||null,headerRows:L}),c+=1,l=v,l<=0||l>=t.byteLength)break}return n}function c(e){t(L,y("div",{class:"error"},String(e))),C&&(C.style.display="none"),T&&(T.innerHTML=""),H&&(H.innerHTML="")}function u(e){L&&(L.textContent=String(e))}function f(){C&&S&&N&&(M.hdus.length?(C.style.display="block",S.innerHTML="",M.hdus.forEach((e=>{const t=`[${e.index}] ${e.type}  name='${e.name}'  shape=${e.data_shape}`,n=y("option",{value:String(e.index),text:t});S.appendChild(n)})),S.value=String(M.selected??0),N.textContent=`HDU \u6570\u91cf\uff1a${M.hdus.length}`):C.style.display="none")}function m(){if(!T)return;if(!M.hdus.length)return void(T.innerHTML="");const t=["index","name","type","ver","data_shape","bitpix","naxis"],n=M.hdus.map((e=>[e.index,e.name,e.type,e.ver,e.data_shape,e.bitpix,e.naxis]));T.innerHTML="",e(T,y("h4",{},"HDU \u6982\u89c8")),e(T,E(t,n,{filterable:!1}))}function h(){if(!H)return;if(!M.hdus.length)return void(H.textContent="\u5c1a\u672a\u9009\u62e9 HDU\u3002");const t=M.selected??0,n=M.hdus.find((e=>e.index===Number(t)));n?(H.innerHTML="",e(H,y("h4",{},`HDU ${n.index} Header`)),e(H,E(["KEYWORD","VALUE","COMMENT"],n.headerRows,{filterable:!0}))):H.textContent="HDU \u7d22\u5f15\u8d85\u51fa\u8303\u56f4\u3002"}function p(e){if(!e||e<=0)return"0 B";const t=["B","KB","MB","GB","TB"];let n=0,r=e;for(;r>=1024&&n<t.length-1;)r/=1024,n++;return r.toFixed(r>=100?0:r>=10?1:2)+" "+t[n]}function g(e){const t=String(e||"").toLowerCase();return D.some((e=>t.endsWith(e)))}function v(e){if(!e)return;if(!g(e.name))return void c(`\u6587\u4ef6\u683c\u5f0f\u4e0d\u652f\u6301\uff1a${e.name}\u3002\u4ec5\u652f\u6301 .fits/.fit/.fts`);b.classList.remove("dragover"),u(`\u52a0\u8f7d\u4e2d\uff1a${e.name} ...`);const t=new FileReader;t.onload=()=>{try{const n=l(t.result);M.filename=e.name,M.hdus=n,M.selected=0,u(`\u5df2\u52a0\u8f7d\u6587\u4ef6\uff1a${e.name} | \u5927\u5c0f\uff1a${p(e.size)} | HDU \u6570\u91cf\uff1a${n.length}`),f(),m(),h()}catch(e){c(`\u89e3\u6790\u5931\u8d25\uff1a${e?.message||e}`)}},t.onerror=()=>c("\u8bfb\u53d6\u6587\u4ef6\u5931\u8d25\u3002"),t.readAsArrayBuffer(e)}const y=(t,n={},r=[])=>{const i=document.createElement(t);for(const[e,t]of Object.entries(n))null!=t&&("class"===e?i.className=String(t):"text"===e?i.textContent=String(t):i.setAttribute(e,String(t)));const o=Array.isArray(r)?r:[r];for(const t of o)e(i,t);return i},E=(t,n,r={})=>{const i=y("div"),o=y("table"),s=y("thead"),d=y("tr");(t||[]).forEach(((e,t)=>{const n=y("th",{"data-idx":String(t),title:"\u70b9\u51fb\u6392\u5e8f"},e??"");d.appendChild(n)})),s.appendChild(d);const a=y("tbody"),l=e=>{a.innerHTML="";for(const n of e||[]){const e=document.createElement("tr");for(let r=0;r<(t||[]).length;r++){const t=document.createElement("td");t.textContent=n&&null!=n[r]?String(n[r]):"",e.appendChild(t)}a.appendChild(e)}};l(n||[]);let c={idx:-1,dir:1};s.addEventListener("click",(e=>{const t=e.target.closest("th");if(!t)return;const r=+t.dataset.idx;c.idx===r?c.dir*=-1:(c.idx=r,c.dir=1);const i=[...n||[]].sort(((e,t)=>{const n=e?.[r],i=t?.[r],o=Number(n),s=Number(i);return(Number.isFinite(o)&&Number.isFinite(s)?o-s:String(n??"").localeCompare(String(i??"")))*c.dir}));l(i)})),o.appendChild(s),o.appendChild(a);const u=y("div",{class:"table-wrap"},o);if(r.filterable){const t=y("div",{class:"toolbar"},[y("span",{},"\u7b5b\u9009\uff1a"),y("input",{type:"text",placeholder:"\u8f93\u5165\u5173\u952e\u5b57\uff08\u5bf9\u6240\u6709\u5217\u751f\u6548\uff09"})]),r=t.querySelector("input"),o=(n||[]).slice();r.addEventListener("input",(()=>{const e=r.value.trim().toLowerCase();if(!e)return void l(o);const t=o.filter((t=>(t||[]).some((t=>String(t).toLowerCase().includes(e)))));l(t)})),e(i,t)}return e(i,u),i},b=document.getElementById("uploader"),x=document.getElementById("fhv-file-input"),L=document.getElementById("fhv-file-info"),C=document.getElementById("fhv-controls"),S=document.getElementById("fhv-hdu-select"),N=document.getElementById("fhv-hdu-count"),T=document.getElementById("fhv-summary"),H=document.getElementById("fhv-header");if(!b||!x)return;const D=[".fits",".fit",".fts"];let M={filename:null,hdus:[],selected:0};b.addEventListener("click",(()=>x.click())),x.addEventListener("change",(e=>v(e.target.files&&e.target.files[0]))),b.addEventListener("dragover",(e=>{e.preventDefault(),b.classList.add("dragover")})),b.addEventListener("dragleave",(e=>{e.preventDefault(),b.classList.remove("dragover")})),b.addEventListener("drop",(e=>{e.preventDefault(),b.classList.remove("dragover");v(e.dataTransfer.files&&e.dataTransfer.files[0])})),S&&S.addEventListener("change",(e=>{M.selected=Number(e.target.value),h()}))}));